{{- if .Values.extractor.enabled }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.extractor.name }}-allocation
  labels:
    app.kubernetes.io/name: {{ .Values.extractor.name }}-allocation
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/component: extractor-cron
    app.kubernetes.io/part-of: kubecost-integration
spec:
  schedule: {{ .Values.extractor.schedule.allocation | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ .Values.extractor.name }}-allocation
            app.kubernetes.io/instance: {{ .Release.Name }}
            app.kubernetes.io/component: extractor-cron
        spec:
          serviceAccountName: {{ include "kubecost-integration.serviceAccountName" . }}
          securityContext:
            {{- toYaml .Values.podSecurityContext | nindent 12 }}
          containers:
          - name: allocation-extractor
            securityContext:
              {{- toYaml .Values.securityContext | nindent 14 }}
            image: "{{ .Values.global.imageRegistry }}/{{ .Values.extractor.image.repository }}:{{ .Values.extractor.image.tag | default .Values.global.imageTag }}"
            imagePullPolicy: {{ .Values.extractor.image.pullPolicy | default .Values.global.imagePullPolicy }}
            command: ["python", "extract_allocations.py"]
            env:
            - name: KUBECOST_ENDPOINT
              value: {{ (.Values.extractor.config.kubecostEndpoint | default (printf "http://%s-cost-analyzer.%s.svc.cluster.local:9090" .Release.Name .Release.Namespace)) | quote }}
            - name: CLOUDTUNER_INFLUXDB_URL
              value: {{ .Values.kubecost.cloudtuner.storage.influxdb | quote }}
            - name: CLOUDTUNER_CLICKHOUSE_URL
              value: {{ .Values.kubecost.cloudtuner.storage.clickhouse | quote }}
            - name: BATCH_SIZE
              value: {{ .Values.extractor.config.batchSize | quote }}
            - name: TIMEOUT
              value: {{ .Values.extractor.config.timeout | quote }}
            - name: MAX_RETRIES
              value: {{ .Values.extractor.config.retries | quote }}
            - name: LOG_LEVEL
              value: "INFO"
            resources:
              {{- toYaml .Values.extractor.resources | nindent 14 }}
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.extractor.name }}-assets
  labels:
    app.kubernetes.io/name: {{ .Values.extractor.name }}-assets
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/component: extractor-cron
    app.kubernetes.io/part-of: kubecost-integration
spec:
  schedule: {{ .Values.extractor.schedule.assets | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ .Values.extractor.name }}-assets
            app.kubernetes.io/instance: {{ .Release.Name }}
            app.kubernetes.io/component: extractor-cron
        spec:
          serviceAccountName: {{ include "kubecost-integration.serviceAccountName" . }}
          securityContext:
            {{- toYaml .Values.podSecurityContext | nindent 12 }}
          containers:
          - name: assets-extractor
            securityContext:
              {{- toYaml .Values.securityContext | nindent 14 }}
            image: "{{ .Values.global.imageRegistry }}/{{ .Values.extractor.image.repository }}:{{ .Values.extractor.image.tag | default .Values.global.imageTag }}"
            imagePullPolicy: {{ .Values.extractor.image.pullPolicy | default .Values.global.imagePullPolicy }}
            command: ["python", "extract_assets.py"]
            env:
            - name: KUBECOST_ENDPOINT
              value: {{ (.Values.extractor.config.kubecostEndpoint | default (printf "http://%s-cost-analyzer.%s.svc.cluster.local:9090" .Release.Name .Release.Namespace)) | quote }}
            - name: CLOUDTUNER_INFLUXDB_URL
              value: {{ .Values.kubecost.cloudtuner.storage.influxdb | quote }}
            - name: CLOUDTUNER_CLICKHOUSE_URL
              value: {{ .Values.kubecost.cloudtuner.storage.clickhouse | quote }}
            - name: BATCH_SIZE
              value: {{ .Values.extractor.config.batchSize | quote }}
            - name: TIMEOUT
              value: {{ .Values.extractor.config.timeout | quote }}
            - name: MAX_RETRIES
              value: {{ .Values.extractor.config.retries | quote }}
            - name: LOG_LEVEL
              value: "INFO"
            resources:
              {{- toYaml .Values.extractor.resources | nindent 14 }}
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          volumes:
          - name: tmp
            emptyDir: {}
          restartPolicy: OnFailure
{{- end }}
